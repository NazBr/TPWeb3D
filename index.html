<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="https://aframe.io/releases/0.9.2/aframe.min.js"></script>

  <script>
    AFRAME.registerComponent('jump-controls', {
      schema:{jumpSpeed:{default:5.5}, gravity:{default:-13}, groundY:{default:0.5}},
      init(){ this.vy=0; this.grounded=true; this.spaceHeld=false;
        window.addEventListener('keydown', e=>{
          if(e.code==='Space' && !this.spaceHeld && this.grounded){
            this.vy=this.data.jumpSpeed; this.grounded=false; this.spaceHeld=true;
          }
        });
        window.addEventListener('keyup', e=>{ if(e.code==='Space') this.spaceHeld=false; });
      },
      tick(t,dtMs){
        const dt=dtMs/1000, p=this.el.object3D.position;
        if(!this.grounded){
          this.vy+=this.data.gravity*dt; p.y+=this.vy*dt;
          if(p.y<=this.data.groundY){ p.y=this.data.groundY; this.vy=0; this.grounded=true; }
        } else if (p.y!==this.data.groundY){ p.y=this.data.groundY; }
      }
    });
    AFRAME.registerComponent('smooth-move', {
        schema:{maxSpeed:{default:6}, accel:{default:22}, decel:{default:14}, cam:{type:'selector'}},
        init(){
            this.vel=new THREE.Vector3();
            this.keys={};
            this.tmpDir=new THREE.Vector3();
            this.qYaw=new THREE.Quaternion();
            window.addEventListener('keydown', e=>this.keys[e.code]=true);
            window.addEventListener('keyup',   e=>this.keys[e.code]=false);
        },
        tick(t,dtMs){
            const dt=dtMs/1000, p=this.el.object3D.position;

            this.tmpDir.set(
                (this.keys['KeyD']?1:0)+(this.keys['KeyA']?-1:0), 
                0,
                (this.keys['KeyS']?1:0)+(this.keys['KeyW']?-1:0)
            );

        if(this.tmpDir.lengthSq()>0){
            this.tmpDir.normalize();

            if(this.data.cam){
                const yawRot = this.data.cam.object3D.rotation.y;
                this.qYaw.setFromAxisAngle(new THREE.Vector3(0,1,0), yawRot);
                this.tmpDir.applyQuaternion(this.qYaw);
            }

            this.vel.x+=this.tmpDir.x*this.data.accel*dt;
            this.vel.z+=this.tmpDir.z*this.data.accel*dt;
            const sp=Math.sqrt(this.vel.x*this.vel.x+this.vel.z*this.vel.z);
            if(sp>this.data.maxSpeed){ 
                const k=this.data.maxSpeed/sp; 
                this.vel.x*=k; 
                this.vel.z*=k; 
            }
        }else{
            const dec=this.data.decel*dt;
            this.vel.x=Math.abs(this.vel.x)<=dec?0:this.vel.x-(this.vel.x>0?dec:-dec);
            this.vel.z=Math.abs(this.vel.z)<=dec?0:this.vel.z-(this.vel.z>0?dec:-dec);
        }

        p.x+=this.vel.x*dt; 
        p.z+=this.vel.z*dt;
    }
    });

    AFRAME.registerComponent('follow-target', {
      schema:{target:{type:'selector'}, damping:{default:0.2}, yOffset:{default:0.0}},
      init(){ this.tmp=new THREE.Vector3(); },
      tick(t,dtMs){
        if(!this.data.target) return;
        const dt=Math.min(dtMs/1000,0.05);
        const s=1-Math.pow(1-this.data.damping, dt*60);
        this.data.target.object3D.getWorldPosition(this.tmp);
        this.tmp.y+=this.data.yOffset;
        this.el.object3D.position.lerp(this.tmp, s);
      }
    });
    AFRAME.registerComponent('orbit-controls', {
      schema:{
        minPitchDeg:{default:-80}, maxPitchDeg:{default:-10},  
        rotateSpeed:{default:0.35}, zoomSpeed:{default:1.0},
        distance:{default:10}, minDistance:{default:3}, maxDistance:{default:25}
      },
      init(){
        this.yawEl   = this.el;                                 
        this.pitchEl = this.el.querySelector('[data-pitch]');  
        this.camEl   = this.el.querySelector('[data-cam]');    
        if(!this.pitchEl||!this.camEl){ console.error('orbit-controls: rig structure invalide'); return; }
        this.drag=false; this.lx=0; this.ly=0;
        this.yaw=45;   this.tyaw=this.yaw;
        this.pitch=-30;this.tpitch=this.pitch;                 
        this.dist=this.data.distance; this.tdist=this.dist;
        window.addEventListener('mousedown', e=>{
          if(e.button!==0) return; this.drag=true; this.lx=e.clientX; this.ly=e.clientY; e.preventDefault();
        });
        window.addEventListener('mousemove', e=>{
          if(!this.drag) return;
          const dx=e.clientX-this.lx, dy=e.clientY-this.ly; this.lx=e.clientX; this.ly=e.clientY;
          this.tyaw   -= dx * this.data.rotateSpeed * 0.01; 
          this.tpitch -= dy * this.data.rotateSpeed * 0.01; 
          this.tpitch = THREE.Math.clamp(this.tpitch, this.data.minPitchDeg, this.data.maxPitchDeg);
        });
        window.addEventListener('mouseup', ()=>{ this.drag=false; });
        window.addEventListener('wheel', e=>{
          e.preventDefault();
          const factor = Math.exp(e.deltaY * 0.001 * this.data.zoomSpeed); 
          this.tdist = THREE.Math.clamp(this.tdist * factor, this.data.minDistance, this.data.maxDistance);
        }, {passive:false});
        this._apply(1);
      },
      _apply(k){
        this.yaw   = THREE.Math.lerp(this.yaw,   this.tyaw,   k);
        this.pitch = THREE.Math.lerp(this.pitch, this.tpitch, k);
        this.dist  = THREE.Math.lerp(this.dist,  this.tdist,  k);
        this.yawEl.object3D.rotation.y   = THREE.Math.degToRad(this.yaw);
        this.pitchEl.object3D.rotation.x = THREE.Math.degToRad(this.pitch);
        this.camEl.object3D.position.set(0, 0, this.dist);
        this.camEl.object3D.rotation.set(0,0,0);
      },
      tick(t,dtMs){
        const dt=Math.min(dtMs/1000,0.05);
        const s = 1 - Math.pow(1-0.18, dt*60); 
        this._apply(s);
      }
    });
  </script>
</head>
<body>
  <a-scene>
    <a-assets>
      <img id="sky" src="panorama4.png">
      <img id="groundTexture" src="grass.png">
    </a-assets>

    <a-plane rotation="-90 0 0" width="100" height="100"
             src="#groundTexture" material="side: double"></a-plane>
    <a-sky src="#sky"></a-sky>

    <a-box id="player" position="0 0.5 0" color="green"
       smooth-move="maxSpeed:6; accel:22; decel:14; cam:#camYaw"
       jump-controls="jumpSpeed:5.5; gravity:-13; groundY:0.5"></a-box>


    <a-entity id="camPivot" follow-target="target:#player; damping:0.20; yOffset:0.0">
      <a-entity id="camYaw" orbit-controls="distance:10; 
                                            minDistance:3; 
                                            maxDistance:25; 
                                            minPitchDeg:-80; 
                                            maxPitchDeg:-10; 
                                            rotateSpeed:10.0; 
                                            zoomSpeed:1.0">
        <a-entity data-pitch>
          <a-entity data-cam camera="near:0.01; far:10000; fov:70"></a-entity>
        </a-entity>
      </a-entity>
    </a-entity>
  </a-scene>
</body>
</html>
